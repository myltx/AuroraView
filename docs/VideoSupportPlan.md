# 视频支持开发规划（草稿）

> 本文档用于记录「在 AuroraView 中增加视频浏览/播放能力」的设计思路，当前版本不实现，后续需要时可据此拆分任务与落地开发。

---

## 1. 总体目标与原则

- 在现有「图片浏览 + 修图状态」基础上，扩展为「媒体浏览（图片 + 视频）」。
- 尽量复用当前架构：
  - 目录扫描、侧边栏结构、排序、选择、右键菜单等逻辑保持一致；
  - 大图视图扩展为：图片用现有 `ImageCanvas`，视频用 `<video>` 播放器。
- 分阶段引入功能，优先保证基本浏览体验，再逐步增加分类与工作流整合。

---

## 2. 阶段一：基础视频支持（最小可用）

### 2.1 扩展文件识别

- 在主进程与渲染层中新增一组「视频扩展名」：
  - 最小集：`mp4`, `mov`, `m4v`;
  - 可选扩展：`mkv`, `avi`, `wmv` 等（根据 macOS 支持情况斟酌）。
- 调整目录读取逻辑：
  - `FileSystemService.readDirectory`：在 `filter: "images"` 的基础上增加 `filter: "media"` 或在现有逻辑中允许视频扩展通过；
  - `Viewer.vue` 中构建 `GalleryItem` 时：
    - 添加 `kind: "image" | "video"` 字段；
    - `extension` 字段统一小写处理，便于后续判断。

### 2.2 缩略图网格中的视频项

- `GalleryItem` 数据结构扩展：
  - `type GalleryItem = { path; resource; name; extension?; kind: "image" | "video"; ... }`
- 渲染层处理：
  - 缩略图网格中，如果 `kind === "video"`：
    - 先期可以使用统一视频占位图（图标 + 暗色背景）；
    - 后续可选：使用 `ffmpeg` 或 `ffprobe` 在主进程预生成视频首帧缩略图，并在 `resource` 中指向该缩略图。
  - 可在缩略图下方追加一行视频时长（后续从 metadata 中获取）。
- 交互行为：
  - 单击/多选逻辑与图片一致；
  - 双击视频 → 打开大图视图中的视频播放器（见 2.3）。

### 2.3 大图视图中的视频播放

- 扩展现有 lightbox 结构：
  - 当前 `Viewer.vue` 中的 `viewer-lightbox__canvas` 使用 `ImageCanvas`；
  - 在模板层增加一个 `v-if` 分支：
    - 当 `currentGalleryItem.kind === "image"`：沿用 `ImageCanvas`；
    - 当 `currentGalleryItem.kind === "video"`：渲染 `<video>` 元素。
- `<video>` 播放器最小实现：
  - 属性：
    - `src` 指向 `photon-file://` 或 `file://` 映射的本地路径；
    - `controls` 开关；
    - `autoplay` 可选；
  - 控件：
    - 播放/暂停；
    - 进度条（浏览器原生即可）；
    - 全屏（可以复用已有 `toggleFullscreen`）。
- 键盘与导航：
  - 左右方向键在「上一条 / 下一条媒体」之间切换；
  - 当从图片切换到视频时，自动暂停上一条媒体的播放；
  - `Esc` 关闭大图视图，与当前行为一致。

---

## 3. 阶段二：视频分类与筛选（可选）

### 3.1 类型筛选：图片 / 视频 / 全部

- 在工具栏新增一个「媒体类型筛选」下拉：
  - 选项：
    - 全部媒体；
    - 仅图片；
    - 仅视频。
  - 风格：
    - 与「排序」「修图筛选」统一，使用 icon + dropdown 的形式；
    - 可以复用 `toolbar-dropdown` 组件样式。
- 过滤逻辑：
  - 基于 `GalleryItem.kind` 值在 `galleryItems` 计算属性中追加过滤；
  - 与现有「星级视图」「修图筛选」「搜索」组合使用时，需要注意性能与优先级（类型筛选应在搜索之前或之后保持一致逻辑）。

### 3.2 视频属性与排序

- 主进程中引入 `ffprobe` 或 HTML5 video metadata 读取：
  - 读取字段：`duration`, `width`, `height`（帧率可选）。
  - 将这些属性通过 `FileSystemService` 的结果返回渲染层。
- 渲染层：
  - 在 `GalleryItem` 中增加：`duration?: number; width?: number; height?: number;`
  - 排序选项增加：
    - 时长（短 → 长 / 长 → 短）；
    - 分辨率（高 → 低）。
  - 缩略图标注：
    - 缩略图右下角显示类似 `00:30 · 1920x1080` 的小字；
    - 使用现有的 muted 文本样式，避免信息过载。

### 3.3 统一媒体视图（视频聚合）

- 在侧边栏新增一个聚合视图：
  - 类似「星级图片」，增加「视频」节点；
  - 点击后使用一个虚拟路径（如 `__videos__`）驱动 `Viewer.vue`：
    - 主进程提供「按扩展名过滤视频并聚合」的 API；
    - 渲染层在 `activateDirectory` 中识别该虚拟路径并调用对应逻辑。

---

## 4. 阶段三：工作流整合（高级功能，后续再评估）

### 4.1 同名分组：照片 + 视频

- 进一步扩展当前的“同名分组”（RAW + PSD）概念：
  - 将 `photo.dng / photo.jpg / photo.psd / photo.mov` 视为一个完整拍摄单元；
  - 在某个视图中按时间线 / 文件名聚合展示，并提供筛选：
    - 仅显示包含视频的分组；
    - 或仅显示包含 RAW+PSD 的分组。
- 可能的 UI 形态：
  - 新增一个「拍摄集合」视图，单个集合卡片上标注包含的类型（RAW / PSD / 视频等）；
  - 双击集合卡片后进入“组内浏览”模式，展示该组的所有媒体。

### 4.2 评分与标签扩展到视频

- 复用现有评分（星级）模型：
  - 允许对视频也打星；
  - 在「星级图片」视图中同时展示图片和视频（可后续再区分视图）。
- 「已修/未修」在视频场景的定义：
  - 待后续实际使用反馈后再决定是否需要为视频引入类似“剪辑完成”的标记；
  - 目前建议仅把“已修/未修”用于 RAW/PSD 分组，以免语义过重。

### 4.3 外部应用工作流

- 在现有「扩展名 → 外部应用」映射基础上：
  - 为 `.mov`、`.mp4` 等标题给出更清晰的默认建议：
    - 例如：`mov → Final Cut Pro`（如果本机已安装）；
  - 为视频右键菜单增加：
    - 「在剪辑软件中打开」子菜单（可根据常见剪辑软件列表生成）。

---

## 5. 实施顺序建议

1. **阶段一：基础视频支持**
   - 扩展扩展名识别；
   - 支持视频缩略图占位图；
   - 在大图视图中使用 `<video>` 播放。
2. **阶段二：类型筛选 + 视频属性**
   - 添加「仅图片 / 仅视频 / 全部」筛选；
   - 读取并展示视频时长等基本属性。
3. **阶段三：工作流整合**
   - 根据实际使用反馈，按需引入“拍摄集合”“视频评分”等更高级特性。

> 注：本规划文档仅作为未来开发参考，不代表当前版本已实现相关功能。实现时应结合当时的代码状态与用户反馈适当调整细节。

